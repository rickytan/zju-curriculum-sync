function loadjs(f,e){var a=document.getElementsByTagName("head")[0];if(a){var d=document.createElement("script");d.setAttribute("src",f);d.setAttribute("type","text/javascript");d.onreadystatechange=function(){if(this.readyState=="complete"||this.readyState=="loaded")try{this.onload()}catch(a){}};d.onload=e!==void 0?e:null;a.appendChild(d)}}var oauth=oauth||chrome.extension.getBackgroundPage().oauth,App=App||{};
$(function(){function f(a,d){return{dateTime:a+"T"+d+":00+08:00",timeZone:"Asia/Shanghai"}}function e(){var a=document.getElementById("login");return!a.user_id.value||!a.password.value?($("#fail").show(300).find("#msg").text("\u8bf7\u8f93\u5165\u5b8c\u6574"),false):true}App.onauth=function(){oauth.hasToken()?($("#auth").text("\u9000\u51fa").click(function(){oauth.clearTokens();$("#login").slideUp("fast",function(){window.close()})}),$("#login").slideDown("slow")):$("#auth").click(function(){chrome.tabs.create({url:chrome.extension.getURL("auth.html")})})};
App.onload=function(){App.onauth()};App.onlist=function(a){a=JSON.parser(a);console.log(a)};App.postToGoogle=function(a){oauth.sendSignedRequest("https://www.googleapis.com/calendar/v3/users/me/calendarList",function(d){d=JSON.parse(d);if(d.error)$(".mask").fadeOut(200),$("#fail").show(300).find("#msg").text(d.error);else{var i="https://www.googleapis.com/calendar/v3/calendars/"+d.items[d.items.length-1].id+"/events",g=function(b,a){try{var g=Config.getDuration(),d=Config.getSemester(),c=new Date((new Date).getFullYear()+
"-"+d[b.semester].start);c.setTime(c.getTime()+864E5*((b.weekday+7-c.getDay())%7));var e=f($.datepicker.formatDate("yy-mm-dd",c),g[b.start-1].start),j=f($.datepicker.formatDate("yy-mm-dd",c),g[b.start+b.length-2].end),h=new Date(d[b.semester].end);h.setFullYear(b.semester>=3?(new Date).getFullYear()+1:(new Date).getFullYear());var k="RRULE:FREQ=WEEKLY;INTERVAL=1;BYDAY="+"SU,MO,TU,WE,TH,FR,SA,SU".split(",")[b.weekday]+";UNTIL="+$.datepicker.formatDate("yymmdd",h),l={method:"POST",parameters:{key:"AIzaSyBvRRGf1uUfCewgR2Rwm6JSHa0vFmMu3IM"},
headers:{"GData-Version":"3.0","Content-Type":"application/json"},body:JSON.stringify({end:j,start:e,location:b.pos,summary:b.name,description:b.time,recurrence:[k],reminders:{useDefault:false,overrides:[{method:"popup",minutes:15}]}})};oauth.sendSignedRequest(i,function(b){b=JSON.parse(b);console.log(b);b.error?($(".mask").fadeOut(200),$("#fail").show(300).find("#msg").text("\u5bfc\u5165\u5931\u8d25")):a()},l)}catch(m){$(".mask").fadeOut(200),$("#fail").show(300).find("#msg").text("\u6570\u636e\u683c\u5f0f\u9519\u8bef")}},
c=function(){var b=a.shift();b!==void 0?g(b,c):($(".mask").fadeOut(200),$("#success").show(300))};a instanceof Array&&c()}},null)};$("#login").submit(function(){if(e()){var a=$("input[name=user_id]").val(),d=$("input[name=password]").val();$.ajax({type:"POST",url:"http://grsinfo.zju.edu.cn/login_s_code.jsp",dataType:"json",data:{user_id:a,password:d},timeout:3E3,success:function(a){if(a.redirect==this.url)window.location.href=a.redirect},error:function(a){/\u767b\u5f55/gi.test(a.responseText)?$("#fail").show(300).find("#msg").text("\u767b\u5f55\u5931\u8d25"):
($("body").append("</div>"),$.get("http://grsinfo.zju.edu.cn/cultivate/selectles/selectbefore/xkhxkbcx.jsp",function(a){var c=a.match(/)<[^<]*)*<\/script>/gi)[0],a=a.replace(/)<[^<]*)*<\/head>/gi,""),a=a.replace(/)<[^<]*)*<\/script>/gi,"");document.getElementById("builder").innerHTML=a;c=/]*>([\s\S]*?)<\/script>/gi.exec(c)[1];a=document.createElement("script");a.setAttribute("type",
"text/javascript");a.innerHTML=c;document.getElementsByTagName("head")[0].appendChild(a);var c=["\u6625","\u590f","\u79cb","\u51ac"],a=document.getElementById("kbT1"),b=c.indexOf(a.previousSibling.textContent.trim().match(/[\u6625\u590f\u79cb\u51ac]/)[0]);b==-1&&(b=4);a=Parser.parse(a,b);b=document.getElementById("kbT2");c=c.indexOf(b.previousSibling.textContent.trim().match(/[\u6625\u590f\u79cb\u51ac]/)[0]);c==-1&&(c=4);c=Parser.parse(b,c);App.postToGoogle(a.concat(c))}).error(function(){$(".mask").fadeOut(200);
$("#fail").show(300).find("#msg").text("\u4f60\u786e\u5b9a\u9009\u8bfe\u7f51\u6ca1\u6302\uff1f")}))}})}return false});App.onload()});